{# templates/robotino.html #}
{% extends "base.html" %}

{% block content %}
<div class="container py-4">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="m-0">Indicateurs Robotino</h2>
    <div class="text-muted small">Source : robotino_data.csv</div>
  </div>

  <!-- KPI -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted small">Batterie (dernier point)</div>
          <div class="d-flex align-items-baseline gap-2">
            <div class="display-6 fw-semibold">
              {{ kpi.battery_pct if kpi and kpi.battery_pct is not none else "—" }}
            </div>
            <div class="fs-4 text-muted">%</div>
          </div>
          <div class="mt-2">
            {% if kpi and kpi.battery_low %}
              <span class="badge bg-danger">Batterie faible</span>
            {% else %}
              <span class="badge bg-success">OK</span>
            {% endif %}
          </div>
          <div class="mt-2 text-muted small">
            Autonomie estimée :
            <strong>{{ kpi.autonomy_hours if kpi and kpi.autonomy_hours is not none else "—" }}</strong> h
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted small">Autonomie totale à 100%</div>
          <div class="d-flex align-items-center gap-2 mt-2">
            <input id="autonomyFullHours" type="number" class="form-control" step="0.1" min="0" value="{{ autonomy_full_hours if autonomy_full_hours is not none else 2.0 }}">
            <span class="text-muted">heures</span>
          </div>
          <div class="text-muted small mt-2">
            Formule : (batterie% / 100) × autonomie totale.
          </div>
          <div class="text-muted small">
            (Modifie ce champ pour recalculer la courbe.)
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted small">Disponibilité (proxy V2)</div>
          <div class="d-flex align-items-baseline gap-2">
            <div class="display-6 fw-semibold">
              {{ kpi.availability_pct if kpi and kpi.availability_pct is not none else "—" }}
            </div>
            <div class="fs-4 text-muted">%</div>
          </div>
          <div class="text-muted small mt-2">
            Proxy : temps “en mouvement” (odometry_vx/vy) / temps total observé.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtres + alertes -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-12 col-md-3">
          <label class="form-label">Seuil batterie critique (%)</label>
          <input id="criticalThreshold" type="number" class="form-control" step="1" min="0" max="100" value="15">
        </div>
        <div class="col-12 col-md-4">
          <div id="batteryAlert" class="alert alert-warning mb-0 d-none" role="alert">
            Seuil critique atteint sur la période affichée.
          </div>
        </div>
        <div class="col-12 col-md-5 text-md-end">
          <button id="resetZoomBtn" class="btn btn-outline-secondary">Réinitialiser (affichage)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Graphs -->
  <div class="row g-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h5 class="m-0">Batterie (%) & Autonomie (h) vs Temps</h5>
            <span class="text-muted small">Courbe</span>
          </div>
          <div style="height: 380px;">
            <canvas id="batteryChart"></canvas>
          </div>
          <div class="text-muted small mt-2">
            BatteryLow / alertes basées sur <code>power_batteryLow</code> et flags festool.
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h5 class="m-0">Cycles (proxy via “en charge”)</h5>
            <span class="text-muted small">Barres</span>
          </div>
          <div style="height: 340px;">
            <canvas id="cycleChart"></canvas>
          </div>
          <div class="text-muted small mt-2">
            Détection charge : <code>power_ext_power</code>. On calcule <em>charge</em>, <em>travel</em>, <em>total</em>.
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h5 class="m-0">Détails cycles (table)</h5>
            <span class="text-muted small">Top 50</span>
          </div>

          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>Cycle</th>
                  <th class="text-end">Charge (min)</th>
                  <th class="text-end">Dépl. (min)</th>
                  <th class="text-end">Total (min)</th>
                </tr>
              </thead>
              <tbody>
                {% if cycles and cycles|length > 0 %}
                  {% for c in cycles[:50] %}
                    <tr>
                      <td>{{ c.label }}</td>
                      <td class="text-end">{{ c.charge_min if c.charge_min is not none else "—" }}</td>
                      <td class="text-end">{{ c.travel_min if c.travel_min is not none else "—" }}</td>
                      <td class="text-end">{{ c.total_min if c.total_min is not none else "—" }}</td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="4" class="text-muted">Aucun cycle détecté.</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>

<!-- Data from Flask (Jinja -> JS) -->
<script>
  const ROBOTINO_TS = {{ (robotino_ts or []) | tojson }};
  const BATTERY_PCT = {{ (battery_pct or []) | tojson }};
  const AUTONOMY_H_SERVER = {{ (autonomy_h or []) | tojson }};
  const BATTERY_LOW = {{ (battery_low or []) | tojson }};
  const EXT_POWER = {{ (ext_power or []) | tojson }};
  const CYCLES = {{ (cycles or []) | tojson }};
</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  function clampNumber(v, min, max, fallback) {
    const n = Number(v);
    if (Number.isNaN(n)) return fallback;
    return Math.max(min, Math.min(max, n));
  }

  function computeAutonomySeries(batteryPct, autonomyFullHours) {
    return batteryPct.map(v => {
      if (v === null || v === undefined) return null;
      const n = Number(v);
      if (Number.isNaN(n)) return null;
      return (n / 100.0) * autonomyFullHours;
    });
  }

  function anyCriticalBattery(batteryPct, threshold) {
    for (let i = 0; i < batteryPct.length; i++) {
      const v = batteryPct[i];
      if (v === null || v === undefined) continue;
      const n = Number(v);
      if (!Number.isNaN(n) && n <= threshold) return true;
    }
    return false;
  }

  // Convert timestamps for labels (keep ISO string but nicer on hover)
  const labels = ROBOTINO_TS;

  // Battery chart with 2 y-axes
  const ctxBattery = document.getElementById("batteryChart");
  const autonomyFullInput = document.getElementById("autonomyFullHours");
  const criticalInput = document.getElementById("criticalThreshold");
  const alertBox = document.getElementById("batteryAlert");
  const resetBtn = document.getElementById("resetZoomBtn");

  const batteryDataset = {
    label: "Batterie (%)",
    data: BATTERY_PCT,
    yAxisID: "yBattery",
    borderWidth: 2,
    pointRadius: 0,
    spanGaps: true,
    tension: 0.15,
  };

  // autonomy computed client-side so user can change full hours
  const autonomyDataset = {
    label: "Autonomie (h)",
    data: computeAutonomySeries(BATTERY_PCT, clampNumber(autonomyFullInput.value, 0, 999, 2.0)),
    yAxisID: "yAutonomy",
    borderWidth: 2,
    pointRadius: 0,
    spanGaps: true,
    tension: 0.15,
  };

  const lowFlagDataset = {
    label: "Batterie faible (flag)",
    data: BATTERY_LOW.map(v => v ? 1 : null),
    yAxisID: "yFlag",
    borderWidth: 0,
    pointRadius: 0,
    showLine: false,
  };

  const batteryChart = new Chart(ctxBattery, {
    type: "line",
    data: {
      labels,
      datasets: [batteryDataset, autonomyDataset]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: { display: true },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const v = ctx.raw;
              if (v === null || v === undefined) return `${ctx.dataset.label}: —`;
              const n = Number(v);
              if (Number.isNaN(n)) return `${ctx.dataset.label}: —`;
              const suffix = ctx.dataset.yAxisID === "yBattery" ? "%" : " h";
              return `${ctx.dataset.label}: ${n.toFixed(2)}${suffix}`;
            }
          }
        }
      },
      scales: {
        x: {
          ticks: { maxTicksLimit: 8 },
        },
        yBattery: {
          type: "linear",
          position: "left",
          min: 0,
          max: 100,
          title: { display: true, text: "Batterie (%)" }
        },
        yAutonomy: {
          type: "linear",
          position: "right",
          beginAtZero: true,
          grid: { drawOnChartArea: false },
          title: { display: true, text: "Autonomie (h)" }
        }
      }
    }
  });

  // Cycles chart
  const ctxCycle = document.getElementById("cycleChart");
  const cycleLabels = (CYCLES || []).slice(0, 30).map(c => c.label);
  const chargeData = (CYCLES || []).slice(0, 30).map(c => c.charge_min ?? null);
  const travelData = (CYCLES || []).slice(0, 30).map(c => c.travel_min ?? null);
  const totalData  = (CYCLES || []).slice(0, 30).map(c => c.total_min  ?? null);

  const cycleChart = new Chart(ctxCycle, {
    type: "bar",
    data: {
      labels: cycleLabels,
      datasets: [
        { label: "Charge (min)", data: chargeData, borderWidth: 1 },
        { label: "Déplacement (min)", data: travelData, borderWidth: 1 },
        { label: "Total (min)", data: totalData, borderWidth: 1 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      plugins: { legend: { display: true } },
      scales: {
        x: { stacked: false, ticks: { maxTicksLimit: 10 } },
        y: { beginAtZero: true, title: { display: true, text: "Minutes" } }
      }
    }
  });

  function refreshAlertsAndAutonomy() {
    const fullHours = clampNumber(autonomyFullInput.value, 0, 999, 2.0);
    const threshold = clampNumber(criticalInput.value, 0, 100, 15);

    // update autonomy line
    autonomyDataset.data = computeAutonomySeries(BATTERY_PCT, fullHours);
    batteryChart.update();

    // alert if critical battery is reached
    const isCritical = anyCriticalBattery(BATTERY_PCT, threshold);
    alertBox.classList.toggle("d-none", !isCritical);
  }

  autonomyFullInput.addEventListener("input", refreshAlertsAndAutonomy);
  criticalInput.addEventListener("input", refreshAlertsAndAutonomy);

  resetBtn.addEventListener("click", () => {
    autonomyFullInput.value = "{{ autonomy_full_hours if autonomy_full_hours is not none else 2.0 }}";
    criticalInput.value = "15";
    refreshAlertsAndAutonomy();
  });

  // Initial
  refreshAlertsAndAutonomy();
</script>
{% endblock %}