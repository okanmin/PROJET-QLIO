{# templates/robotino.html — version “dashboard” (KPI + sparklines + liste scroll + fullscreen) #}
{% extends "base.html" %}

{% block content %}
<style>
  .rbt-wrap{max-width:1200px;margin:0 auto;padding:18px 14px;}
  .rbt-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px;}
  .rbt-title{margin:0;font-size:1.25rem;font-weight:800;letter-spacing:.2px;}
  .rbt-sub{opacity:.65;font-size:.85rem;white-space:nowrap}

  .kpi-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin:12px 0 10px;}
  .kpi{grid-column:span 12;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);
       border-radius:18px;padding:14px;backdrop-filter: blur(8px); box-shadow: 0 10px 30px rgba(0,0,0,.18);}
  @media (min-width: 900px){ .kpi{grid-column:span 4;} }

  .kpi-top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
        background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);font-size:.85rem;opacity:.92}
  .dot{width:10px;height:10px;border-radius:50%;background:#22c55e}
  .dot.bad{background:#ef4444}
  .dot.warn{background:#f59e0b}

  .kpi-value{display:flex;align-items:flex-end;justify-content:space-between;gap:10px}
  .kpi-main{display:flex;align-items:baseline;gap:8px}
  .num{font-size:2.05rem;font-weight:900;line-height:1}
  .unit{opacity:.7;font-size:1rem}
  .spark-wrap{width:120px;height:34px;opacity:.95}
  .spark-wrap canvas{width:100%!important;height:100%!important}

  .rbt-controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:flex-end;margin:10px 0 12px}
  .input-pill{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.04);
              border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:8px 10px}
  .input-pill input{width:84px;background:transparent;border:none;outline:none;color:inherit}
  .btn-pill{border-radius:12px;padding:8px 10px;border:1px solid rgba(255,255,255,.14);
            background:rgba(255,255,255,.04);color:inherit}
  .btn-pill:hover{background:rgba(255,255,255,.08)}
  .alert-chip{display:none;border-color:rgba(239,68,68,.35)!important;background:rgba(239,68,68,.12)!important}

  .panel-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;}
  .panel{grid-column:span 12;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);
         border-radius:18px;padding:14px;box-shadow: 0 10px 30px rgba(0,0,0,.18);}
  @media (min-width: 900px){
    .panel.wide{grid-column:span 12;}
    .panel.half{grid-column:span 6;}
  }

  .panel-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
  .panel-title{margin:0;font-size:1rem;font-weight:800;opacity:.95}
  .panel-actions{display:flex;align-items:center;gap:8px}
  .badge-soft{font-size:.8rem;opacity:.65}

  .canvas-wrap{height:380px}
  .canvas-wrap.sm{height:300px}
  canvas{max-width:100%}

  /* Scroll list */
  .cycle-list{max-height:320px;overflow:auto;padding-right:4px}
  .cycle-item{display:flex;align-items:center;justify-content:space-between;gap:10px;
              padding:10px 12px;margin-bottom:10px;border-radius:16px;
              background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08)}
  .cycle-left{display:flex;flex-direction:column;gap:3px}
  .cycle-title{font-weight:800}
  .cycle-mini{opacity:.7;font-size:.85rem}
  .cycle-right{display:flex;gap:8px;align-items:center}
  .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);
        border:1px solid rgba(255,255,255,.10);font-size:.85rem;white-space:nowrap}
  .muted{opacity:.7}

  /* Fullscreen modal */
  .fs-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;z-index:9998}
  .fs-card{position:fixed;inset:24px;background:#0b0b0b;border:1px solid rgba(255,255,255,.12);
           border-radius:20px;padding:14px;display:none;z-index:9999;box-shadow:0 20px 60px rgba(0,0,0,.6)}
  .fs-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
  .fs-title{margin:0;font-size:1rem;font-weight:800}
  .fs-close{cursor:pointer}
  .fs-body{height:calc(100% - 44px)}
  .fs-body canvas{width:100%!important;height:100%!important}
</style>

<div class="rbt-wrap">
  <div class="rbt-head">
    <h2 class="rbt-title">Robotino</h2>
    <div class="rbt-sub">robotino_data.csv</div>
  </div>

  <!-- KPI -->
  <div class="kpi-grid">
    <div class="kpi">
      <div class="kpi-top">
        <div class="chip">
          <span class="dot {% if kpi and kpi.battery_low %}bad{% endif %}"></span>
          Batterie
        </div>
        <div class="chip muted">Live</div>
      </div>
      <div class="kpi-value">
        <div class="kpi-main">
          <div class="num">{{ kpi.battery_pct if kpi and kpi.battery_pct is not none else "—" }}</div>
          <div class="unit">%</div>
        </div>
        <div class="spark-wrap"><canvas id="sparkBattery"></canvas></div>
      </div>
    </div>

    <div class="kpi">
      <div class="kpi-top">
        <div class="chip"><span class="dot"></span>Autonomie</div>
        <div class="input-pill" title="Autonomie à 100%">
          <span class="muted">100%</span>
          <input id="autonomyFullHours" type="number" step="0.1" min="0"
                 value="{{ autonomy_full_hours if autonomy_full_hours is not none else 2.0 }}">
          <span class="muted">h</span>
        </div>
      </div>
      <div class="kpi-value">
        <div class="kpi-main">
          <div class="num">{{ kpi.autonomy_hours if kpi and kpi.autonomy_hours is not none else "—" }}</div>
          <div class="unit">h</div>
        </div>
        <div class="spark-wrap"><canvas id="sparkAutonomy"></canvas></div>
      </div>
    </div>

    <div class="kpi">
      <div class="kpi-top">
        <div class="chip"><span class="dot"></span>Dispo</div>
        <div class="input-pill" title="Seuil batterie">
          <span class="muted">Seuil</span>
          <input id="criticalThreshold" type="number" step="1" min="0" max="100" value="15">
          <span class="muted">%</span>
        </div>
      </div>
      <div class="kpi-value">
        <div class="kpi-main">
          <div class="num">{{ kpi.availability_pct if kpi and kpi.availability_pct is not none else "—" }}</div>
          <div class="unit">%</div>
        </div>
        <div class="spark-wrap"><canvas id="sparkAvailability"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="rbt-controls">
    <div id="batteryAlert" class="chip alert-chip">
      <span class="dot bad"></span>Seuil atteint
    </div>
    <button id="resetZoomBtn" class="btn-pill">Reset</button>
  </div>

  <!-- Panels -->
  <div class="panel-grid">
    <div class="panel wide">
      <div class="panel-head">
        <h3 class="panel-title">Batterie & autonomie</h3>
        <div class="panel-actions">
          <span class="badge-soft">Temps</span>
          <button class="btn-pill" data-fs="battery">Plein écran</button>
        </div>
      </div>
      <div class="canvas-wrap">
        <canvas id="batteryChart"></canvas>
      </div>
    </div>

    <div class="panel half">
      <div class="panel-head">
        <h3 class="panel-title">Cycles</h3>
        <div class="panel-actions">
          <span class="badge-soft">Top 30</span>
          <button class="btn-pill" data-fs="cycles">Plein écran</button>
        </div>
      </div>
      <div class="canvas-wrap sm">
        <canvas id="cycleChart"></canvas>
      </div>
    </div>

    <div class="panel half">
      <div class="panel-head">
        <h3 class="panel-title">Derniers cycles</h3>
        <div class="panel-actions">
          <span class="badge-soft">Top 20</span>
        </div>
      </div>

      <div class="cycle-list">
        {% if cycles and cycles|length > 0 %}
          {% for c in cycles[:20] %}
          <div class="cycle-item">
            <div class="cycle-left">
              <div class="cycle-title">{{ c.label }}</div>
              <div class="cycle-mini">min</div>
            </div>
            <div class="cycle-right">
              <span class="pill">C {{ c.charge_min if c.charge_min is not none else "—" }}</span>
              <span class="pill">D {{ c.travel_min if c.travel_min is not none else "—" }}</span>
              <span class="pill">T {{ c.total_min if c.total_min is not none else "—" }}</span>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="cycle-item"><span class="muted">—</span></div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Fullscreen -->
<div id="fsBackdrop" class="fs-backdrop"></div>
<div id="fsCard" class="fs-card">
  <div class="fs-head">
    <h3 id="fsTitle" class="fs-title">Graph</h3>
    <button id="fsClose" class="btn-pill fs-close">Fermer</button>
  </div>
  <div class="fs-body">
    <canvas id="fsCanvas"></canvas>
  </div>
</div>

<!-- Data -->
<script>
  const ROBOTINO_TS = {{ (robotino_ts or []) | tojson }};
  const BATTERY_PCT = {{ (battery_pct or []) | tojson }};
  const BATTERY_LOW = {{ (battery_low or []) | tojson }};
  const CYCLES = {{ (cycles or []) | tojson }};
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  function clampNumber(v, min, max, fallback) {
    const n = Number(v);
    if (Number.isNaN(n)) return fallback;
    return Math.max(min, Math.min(max, n));
  }
  function computeAutonomySeries(batteryPct, autonomyFullHours) {
    return batteryPct.map(v => {
      if (v === null || v === undefined) return null;
      const n = Number(v);
      if (Number.isNaN(n)) return null;
      return (n / 100.0) * autonomyFullHours;
    });
  }
  function anyCriticalBattery(batteryPct, threshold) {
    for (let i = 0; i < batteryPct.length; i++) {
      const v = batteryPct[i];
      if (v === null || v === undefined) continue;
      const n = Number(v);
      if (!Number.isNaN(n) && n <= threshold) return true;
    }
    return false;
  }
  function lastN(arr, n) {
    const a = (arr || []).filter(v => v !== null && v !== undefined && !Number.isNaN(Number(v)));
    return a.slice(Math.max(0, a.length - n));
  }

  const labels = ROBOTINO_TS;

  const autonomyFullInput = document.getElementById("autonomyFullHours");
  const criticalInput = document.getElementById("criticalThreshold");
  const alertChip = document.getElementById("batteryAlert");
  const resetBtn = document.getElementById("resetZoomBtn");

  // Main battery chart
  const ctxBattery = document.getElementById("batteryChart");

  const batteryDataset = {
    label: "Batterie",
    data: BATTERY_PCT,
    yAxisID: "yBattery",
    borderWidth: 2,
    pointRadius: 0,
    spanGaps: true,
    tension: 0.18,
  };

  const autonomyDataset = {
    label: "Autonomie",
    data: computeAutonomySeries(BATTERY_PCT, clampNumber(autonomyFullInput.value, 0, 999, 2.0)),
    yAxisID: "yAutonomy",
    borderWidth: 2,
    pointRadius: 0,
    spanGaps: true,
    tension: 0.18,
  };

  const batteryChart = new Chart(ctxBattery, {
    type: "line",
    data: { labels, datasets: [batteryDataset, autonomyDataset] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      plugins: { legend: { display: true } },
      scales: {
        x: { ticks: { maxTicksLimit: 8 } },
        yBattery: { type: "linear", position: "left", min: 0, max: 100 },
        yAutonomy: { type: "linear", position: "right", beginAtZero: true, grid: { drawOnChartArea: false } }
      }
    }
  });

  // Cycles chart
  const ctxCycle = document.getElementById("cycleChart");
  const cycleLabels = (CYCLES || []).slice(0, 30).map(c => c.label);
  const chargeData = (CYCLES || []).slice(0, 30).map(c => c.charge_min ?? null);
  const travelData = (CYCLES || []).slice(0, 30).map(c => c.travel_min ?? null);
  const totalData  = (CYCLES || []).slice(0, 30).map(c => c.total_min  ?? null);

  const cycleChart = new Chart(ctxCycle, {
    type: "bar",
    data: {
      labels: cycleLabels,
      datasets: [
        { label: "Charge", data: chargeData, borderWidth: 1 },
        { label: "Dépl.", data: travelData, borderWidth: 1 },
        { label: "Total", data: totalData, borderWidth: 1 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      plugins: { legend: { display: true } },
      scales: { x: { ticks: { maxTicksLimit: 10 } }, y: { beginAtZero: true } }
    }
  });

  // Sparklines
  function makeSpark(canvasId, data) {
    const ctx = document.getElementById(canvasId);
    return new Chart(ctx, {
      type: "line",
      data: {
        labels: data.map((_, i) => i + 1),
        datasets: [{
          data,
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.25,
          spanGaps: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { enabled: false } },
        scales: { x: { display: false }, y: { display: false } }
      }
    });
  }

  const sparkBattery = makeSpark("sparkBattery", lastN(BATTERY_PCT, 40));
  const sparkAutonomy = makeSpark("sparkAutonomy", lastN(computeAutonomySeries(BATTERY_PCT, clampNumber(autonomyFullInput.value, 0, 999, 2.0)), 40));
  const sparkAvailability = makeSpark("sparkAvailability", lastN([{{ kpi.availability_pct if kpi and kpi.availability_pct is not none else "null" }}], 1));

  // Fullscreen cloning
  const fsBackdrop = document.getElementById("fsBackdrop");
  const fsCard = document.getElementById("fsCard");
  const fsCanvas = document.getElementById("fsCanvas");
  const fsTitle = document.getElementById("fsTitle");
  const fsClose = document.getElementById("fsClose");
  let fsChart = null;

  function openFs(which) {
    if (fsChart) { fsChart.destroy(); fsChart = null; }
    fsBackdrop.style.display = "block";
    fsCard.style.display = "block";

    if (which === "battery") {
      fsTitle.textContent = "Batterie & autonomie";
      fsChart = new Chart(fsCanvas, batteryChart.config);
    } else {
      fsTitle.textContent = "Cycles";
      fsChart = new Chart(fsCanvas, cycleChart.config);
    }
  }

  function closeFs() {
    if (fsChart) { fsChart.destroy(); fsChart = null; }
    fsBackdrop.style.display = "none";
    fsCard.style.display = "none";
  }

  document.querySelectorAll("[data-fs]").forEach(btn => {
    btn.addEventListener("click", () => openFs(btn.getAttribute("data-fs")));
  });
  fsClose.addEventListener("click", closeFs);
  fsBackdrop.addEventListener("click", closeFs);

  // Refresh logic
  function refresh() {
    const fullHours = clampNumber(autonomyFullInput.value, 0, 999, 2.0);
    const threshold = clampNumber(criticalInput.value, 0, 100, 15);

    autonomyDataset.data = computeAutonomySeries(BATTERY_PCT, fullHours);
    batteryChart.update();

    const critical = anyCriticalBattery(BATTERY_PCT, threshold);
    alertChip.style.display = critical ? "inline-flex" : "none";

    // update sparks
    sparkBattery.data.datasets[0].data = lastN(BATTERY_PCT, 40);
    sparkBattery.update();

    const a = computeAutonomySeries(BATTERY_PCT, fullHours);
    sparkAutonomy.data.datasets[0].data = lastN(a, 40);
    sparkAutonomy.update();
  }

  autonomyFullInput.addEventListener("input", refresh);
  criticalInput.addEventListener("input", refresh);

  resetBtn.addEventListener("click", () => {
    autonomyFullInput.value = "{{ autonomy_full_hours if autonomy_full_hours is not none else 2.0 }}";
    criticalInput.value = "15";
    refresh();
  });

  refresh();
</script>
{% endblock %}