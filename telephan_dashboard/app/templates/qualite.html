{% extends "base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="page container">

    <div class="card-title" style="margin-bottom: 20px;">
        <h2 style="font-size: 20px;">Tableau de Bord Qualité & Maintenance</h2>
    </div>

    <div class="grid-3" style="margin-bottom: 24px;">
        <div class="card" style="text-align: center; border-bottom: 4px solid {{ couleur_panne }}; grid-column: span 3;">
        <div class="card-title"><h2 style="justify-content: center;">Statut du Taux d'Arrêt (Pannes)</h2></div>
        
        <div class="kpi" style="color: {{ couleur_panne }}; font-size: 4.5rem; font-weight: bold; margin: 10px 0;">
            {{ taux_panne }} %
        </div>
        
        <p style="color: #a0a0a0; margin-bottom: 15px;">
            {% if taux_panne >= 50 %}
                CRITIQUE : Seuil d'alerte dépassé (>50%)
            {% elif taux_panne >= 20 %}
                ATTENTION : Maintenance préventive à prévoir (>20%)
            {% else %}
                OPTIMAL : La ligne fonctionne correctement
            {% endif %}
        </p>
        
        <div style="width: 100%; background: rgba(255,255,255,0.1); height: 12px; border-radius: 6px; overflow: hidden;">
            <div style="width: {{ taux_panne }}%; background: {{ couleur_panne }}; height: 100%; transition: width 0.8s ease-in-out;"></div>
        </div>
    </div>
    </div>

    <div class="card" style="margin-bottom: 24px;">
        <div class="card-title"><h2>Diagramme de Pareto (Analyse des Erreurs)</h2></div>
        <div style="position: relative; height: 450px; width: 100%;">
            <canvas id="paretoChart"></canvas>
        </div>
    </div>

    <div class="grid-2" style="gap: 20px;">
        <div class="card">
            <div class="card-title"><h2>Consommation Électrique (W)</h2></div>
            <div style="height: 300px;"><canvas id="elecChart"></canvas></div>
        </div>
        <div class="card">
            <div class="card-title"><h2>Consommation Air (L/min)</h2></div>
            <div style="height: 300px;"><canvas id="airChart"></canvas></div>
        </div>
    </div>

</div>

<script>
    const colorWhite = '#ffffff';
    const colorGood = '#2ee59d';
    const colorBad = '#ff4d6d';
    const colorAccent = '#00d4ff';

    // --- PARETO ---
    const dataP = {{ pareto_data | tojson | safe }};
    dataP.sort((a, b) => b.pct - a.pct);
    
    new Chart(document.getElementById('paretoChart'), {
        type: 'bar',
        data: {
            labels: dataP.map(d => d.label),
            datasets: [
                {
                    label: 'Cumul %',
                    data: dataP.map(d => d.cumul),
                    type: 'line',
                    borderColor: colorAccent,
                    yAxisID: 'y1',
                    borderWidth: 3,
                    pointRadius: 4
                },
                {
                    label: 'Proportion %',
                    data: dataP.map(d => d.pct),
                    backgroundColor: dataP.map(d => d.is_ok ? colorGood : colorBad),
                    yAxisID: 'y',
                    borderRadius: 5
                },
                {
                    label: 'Seuil 80%',
                    data: dataP.map(() => 80),
                    type: 'line',
                    borderColor: 'rgba(255,255,255,0.4)',
                    borderDash: [10, 5],
                    pointRadius: 0,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { min: 0, max: 100, ticks: { color: colorWhite } },
                y1: { position: 'right', min: 0, max: 100, ticks: { color: colorWhite }, grid: { drawOnChartArea: false } },
                x: { ticks: { color: colorWhite } }
            },
           plugins: {
                legend: { 
                    labels: { 
                        color: colorWhite, // Couleur par défaut de la légende
                        generateLabels: () => [
                            { text: 'Conforme', fillStyle: colorGood, fontColor: colorWhite },
                            { text: 'Erreur', fillStyle: colorBad, fontColor: colorWhite },
                            { text: 'Courbe Cumul', strokeStyle: colorAccent, lineWidth: 2, fontColor: colorWhite },
                            { text: 'Seuil 80%', strokeStyle: 'white', lineDash: [5, 5], lineWidth: 2, fontColor: colorWhite }
                        ]
                    }
                }
            }
        }
    });

    // --- ENERGIE ---
    const dataE = {{ energy_data | tojson | safe }};
    const eLabels = dataE.map(d => d.machine);

    const configLine = (ctx, label, data, color) => new Chart(ctx, {
        type: 'line',
        data: { labels: eLabels, datasets: [{ label: label, data: data, borderColor: color, tension: 0.4, fill: true, backgroundColor: color + '22' }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: colorWhite } }, x: { ticks: { color: colorWhite } } } }
    });

    configLine(document.getElementById('elecChart'), 'Elec', dataE.map(d => d.elec), '#f1c40f');
    configLine(document.getElementById('airChart'), 'Air', dataE.map(d => d.air), colorAccent);
</script>
{% endblock %}