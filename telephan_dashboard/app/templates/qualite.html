{% extends "base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="page container">

    <div class="card-title" style="margin-bottom: 20px;">
        <h2 style="font-size: 20px;">Diagramme de Pareto - Analyse Globale</h2>
    </div>

    <div class="card">
        <div style="position: relative; height: 500px; width: 100%;">
            <canvas id="paretoChart"></canvas>
        </div>
    </div>

</div>

<script>
    // 1. Récupération des couleurs de votre CSS pour les barres
    const rootStyles = getComputedStyle(document.documentElement);
    const colorGood = rootStyles.getPropertyValue('--good').trim() || '#2ee59d';
    const colorBad = rootStyles.getPropertyValue('--bad').trim() || '#ff4d6d';
    const colorAccent = rootStyles.getPropertyValue('--accent').trim() || '#00d4ff';
    const colorWhite = '#ffffff'; // On force le blanc pur pour le texte

    // 2. Transfert sécurisé des données depuis Python
    let dataFromPython = {{ pareto_data | tojson | safe }};
    
    // 3. TRI CLASSIQUE PARETO : Du plus grand au plus petit pourcentage (Descendant)
    dataFromPython.sort((a, b) => b.pct - a.pct);

    // 4. Extraction des tableaux et recalcul du cumul
    const labels = [];
    const percentages = [];
    const cumulatives = [];
    const barColors = [];
    const paretoLine80 = [];
    
    let currentCumul = 0;

    dataFromPython.forEach(item => {
        labels.push(item.label);
        percentages.push(item.pct);
        
        // Recalcul de la courbe cumulative (de gauche à droite)
        currentCumul += item.pct;
        cumulatives.push(currentCumul > 100 ? 100 : parseFloat(currentCumul.toFixed(1)));
        
        barColors.push(item.is_ok ? colorGood : colorBad);
        paretoLine80.push(80); // Ligne constante à 80%
    });

    // 5. Configuration du graphique mixte
    const ctx = document.getElementById('paretoChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Seuil Pareto (80%)',
                    data: paretoLine80,
                    type: 'line',
                    borderColor: 'rgba(255, 255, 255, 0.6)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    fill: false,
                    yAxisID: 'y1'
                },
                {
                    label: 'Cumul (%)',
                    data: cumulatives,
                    type: 'line',
                    borderColor: colorAccent,
                    backgroundColor: colorAccent,
                    borderWidth: 3,
                    tension: 0.1,
                    fill: false,
                    pointBackgroundColor: colorAccent,
                    pointRadius: 4,
                    yAxisID: 'y1'
                },
                {
                    label: 'Proportion (%)',
                    data: percentages,
                    type: 'bar',
                    backgroundColor: barColors,
                    borderRadius: 4,
                    yAxisID: 'y'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    max: 100,
                    min: 0,
                    title: { display: true, text: 'Proportion de la catégorie (%)', color: colorWhite },
                    ticks: { color: colorWhite },
                    grid: { color: 'rgba(255, 255, 255, 0.05)' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    max: 100,
                    min: 0,
                    title: { display: true, text: 'Cumul Global (%)', color: colorWhite },
                    ticks: { color: colorWhite },
                    grid: { drawOnChartArea: false }
                },
                x: {
                    ticks: { color: colorWhite, maxRotation: 45, minRotation: 0 },
                    grid: { display: false }
                }
            },
            plugins: {
                legend: { 
                    labels: { 
                        color: colorWhite, // Force la couleur principale de la légende en blanc
                        generateLabels: function(chart) {
                            return [
                                // L'attribut fontColor assure que même les libellés personnalisés soient blancs
                                { text: 'Conforme (OK)', fillStyle: colorGood, strokeStyle: colorGood, lineWidth: 0, fontColor: colorWhite },
                                { text: 'Erreur', fillStyle: colorBad, strokeStyle: colorBad, lineWidth: 0, fontColor: colorWhite },
                                { text: 'Courbe de Cumul', fillStyle: colorAccent, strokeStyle: colorAccent, lineWidth: 2, fontColor: colorWhite },
                                { text: 'Seuil 80%', fillStyle: 'transparent', strokeStyle: 'rgba(255, 255, 255, 0.6)', lineDash: [5, 5], lineWidth: 2, fontColor: colorWhite }
                            ];
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + '%';
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}